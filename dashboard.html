<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô</title>
  <link rel="stylesheet" href="dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
</head>
<body>
  <div class="container">
    <h1>üìù ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô</h1>

    <div class="controls">
      <label for="summaryDate">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
      <input type="date" id="summaryDate">

      <label for="classSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
      <select id="classSelect">
        <option value="All">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
        <option value="‡∏°.1/1">‡∏°.1/1</option>
        <option value="‡∏°.1/2">‡∏°.1/2</option>
        <option value="‡∏°.2/1">‡∏°.2/1</option>
        <option value="‡∏°.2/2">‡∏°.2/2</option>
        <option value="‡∏°.2/3">‡∏°.2/2</option>
        <option value="‡∏°.3/1">‡∏°.3/1</option>
        <option value="‡∏°.3/2">‡∏°.3/2</option>
        <option value="‡∏°.4/1">‡∏°.4/1</option>
        <option value="‡∏°.4/2">‡∏°.4/2</option>
        <option value="‡∏°.5/1">‡∏°.5/1</option>
        <option value="‡∏°.5/2">‡∏°.5/2</option>
        <option value="‡∏°.6/1">‡∏°.6/1</option>
        <option value="‡∏°.6/2">‡∏°.6/2</option>
        <option value="‡∏°.6/3">‡∏°.6/3</option>
      </select>
    </div>

    <div class="loading" id="loadingMessage" style="display: none;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div class="error-message" id="errorMessage" style="display: none;"></div>
    <div class="no-data" id="noDataMessage" style="display: none;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>

    <table id="summaryTable" style="display: none;">
      <thead>
        <tr>
          <th>‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
          <th>‡∏°‡∏≤</th>
          <th>‡∏Ç‡∏≤‡∏î</th>
          <th>‡∏•‡∏≤</th>
          <th>‡∏°‡∏≤‡∏™‡∏≤‡∏¢</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>

  <div class="chart-container" id="attendanceChartContainer" style="display: none;">
    <h2>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏Å‡∏£‡∏≤‡∏ü)</h2>
    <canvas id="attendanceChart"></canvas>
  </div>
  <div class="chart-container" id="doughnutChartContainer" style="display: none;">
    <h2>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°)</h2>
    <canvas id="doughnutChart"></canvas>
  </div>

  <div class="chart-container" id="lineChartContainer" style="display: none;">
    <h2>üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô)</h2>
    <canvas id="lineChart"></canvas>
  </div>
  <script>
    // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Web app URL ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google Apps Script ***
    const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzqmJmki36Qa4njKxrVj9p66riFJJ4oyOUatisUQ68iwrx-LZj_UG3IljCLo_GIjaPm/exec'; 

    const summaryDateInput = document.getElementById('summaryDate');
    const classSelect = document.getElementById('classSelect');
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const noDataMessage = document.getElementById('noDataMessage');
    const summaryTable = document.getElementById('summaryTable');
    const summaryTableBody = summaryTable.querySelector('tbody');
    const attendanceChartContainer = document.getElementById('attendanceChartContainer');
    const attendanceChartCanvas = document.getElementById('attendanceChart');
    const doughnutChartContainer = document.getElementById('doughnutChartContainer');
    const doughnutChartCanvas = document.getElementById('doughnutChart');
    const lineChartContainer = document.getElementById('lineChartContainer');
    const lineChartCanvas = document.getElementById('lineChart');

    let myDoughnutChart = null; // Variable for Doughnut Chart instance
    let myLineChart = null; // Variable for Line Chart instance

    let myChart = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö instance ‡∏Ç‡∏≠‡∏á Chart.js

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    summaryDateInput.value = `${year}-${month}-${day}`;

    async function fetchAndDisplayDailySummary() {
      loadingMessage.style.display = 'block';
      errorMessage.style.display = 'none';
      noDataMessage.style.display = 'none';
      summaryTable.style.display = 'none';
      attendanceChartContainer.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡πà‡∏≠‡∏ô
      doughnutChartContainer.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô Doughnut Chart Container
      lineChartContainer.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô Line Chart Container
      summaryTableBody.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

      // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
      if (myChart) {
        myChart.destroy();
      }
      if (myDoughnutChart) {
        myDoughnutChart.destroy();
      }
      if (myLineChart) {
        myLineChart.destroy();
      }

      const selectedDate = summaryDateInput.value;
      const selectedClass = classSelect.value;

      try {
        let url = `${API_ENDPOINT}?date=${selectedDate}`;
        if (selectedClass !== 'All') {
          url += `&class=${selectedClass}`;
        }
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json(); // ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á array ‡∏Ç‡∏≠‡∏á summary objects

        if (data.error) {
            errorMessage.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.error}`;
            errorMessage.style.display = 'block';
            return;
        }

        if (data.length === 0) {
            noDataMessage.style.display = 'block';
            return;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        summaryTable.style.display = 'table';
        data.forEach(item => {
          const row = summaryTableBody.insertRow();
          row.insertCell().textContent = item.className;
          row.insertCell().textContent = item.totalStudents;
          row.insertCell().textContent = item.present;
          row.insertCell().textContent = item.absent;
          row.insertCell().textContent = item.leave;
          row.insertCell().textContent = item.late;
        });

        // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á (Bar Chart) ---
        attendanceChartContainer.style.display = 'block'; // ‡πÅ‡∏™‡∏î‡∏á container ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü

        const classNames = data.map(item => item.className);
        const presentCounts = data.map(item => item.present);
        const absentCounts = data.map(item => item.absent);
        const leaveCounts = data.map(item => item.leave);
        const lateCounts = data.map(item => item.late);

        const chartData = {
          labels: classNames,
          datasets: [
            {
              label: '‡∏°‡∏≤',
              data: presentCounts,
              backgroundColor: '#4CAF50', // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
              borderColor: '#4CAF50',
              borderWidth: 1
            },
            {
              label: '‡∏Ç‡∏≤‡∏î',
              data: absentCounts,
              backgroundColor: '#F44336', // ‡πÅ‡∏î‡∏á
              borderColor: '#F44336',
              borderWidth: 1
            },
            {
              label: '‡∏•‡∏≤',
              data: leaveCounts,
              backgroundColor: '#FFEB3B', // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
              borderColor: '#FFEB3B',
              borderWidth: 1
            },
            {
              label: '‡∏°‡∏≤‡∏™‡∏≤‡∏¢',
              data: lateCounts,
              backgroundColor: '#2196F3', // ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
              borderColor: '#2196F3',
              borderWidth: 1
            }
          ]
        };

        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false, // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
          plugins: {
            title: {
              display: true,
              text: `‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate} ${selectedClass === 'All' ? '(‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô)' : `(${selectedClass})`}`
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
              }
            },
            x: {
              title: {
                display: true,
                text: '‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
              }
            }
          }
        };

        myChart = new Chart(attendanceChartCanvas, {
          type: 'bar',
          data: chartData,
          options: chartOptions
        });

        // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á Doughnut Chart (‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°) ---
        if (data.length > 0) { // Only show if there's data
            doughnutChartContainer.style.display = 'block';

            let totalPresent = 0;
            let totalAbsent = 0;
            let totalLeave = 0;
            let totalLate = 0;

            data.forEach(item => {
                totalPresent += item.present;
                totalAbsent += item.absent;
                totalLeave += item.leave;
                totalLate += item.late;
            });

            const doughnutData = {
                labels: ['‡∏°‡∏≤', '‡∏Ç‡∏≤‡∏î', '‡∏•‡∏≤', '‡∏°‡∏≤‡∏™‡∏≤‡∏¢'],
                datasets: [{
                    data: [totalPresent, totalAbsent, totalLeave, totalLate],
                    backgroundColor: ['#4CAF50', '#F44336', '#FFEB3B', '#2196F3'],
                    hoverOffset: 4
                }]
            };

            const doughnutOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate} ${selectedClass === 'All' ? '(‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô)' : `(‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° ${selectedClass})`}`
                    }
                }
            };

            myDoughnutChart = new Chart(doughnutChartCanvas, {
                type: 'doughnut',
                data: doughnutData,
                options: doughnutOptions
            });
        }

        // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á Line Chart (‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô) ---
        if (data.length > 0) {
            lineChartContainer.style.display = 'block';

            const lineChartData = {
                labels: classNames, // Reusing classNames from the bar chart
                datasets: [
                    {
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤',
                        data: presentCounts, // Reusing presentCounts
                        borderColor: '#2196F3', // Blue color for the line
                        backgroundColor: 'rgba(33, 150, 243, 0.2)', // Light blue fill
                        tension: 0.1, // Smooth the line
                        fill: true,
                        pointBackgroundColor: '#2196F3',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#2196F3'
                    }
                ]
            };

            const lineChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate} ${selectedClass === 'All' ? '(‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô)' : `(${selectedClass})`}`
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
                        }
                    }
                }
            };

            myLineChart = new Chart(lineChartCanvas, {
                type: 'line',
                data: lineChartData,
                options: lineChartOptions
            });
        }

      } catch (error) {
        console.error('Error fetching daily summary:', error);
        errorMessage.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheet';
        errorMessage.style.display = 'block';
      } finally {
        loadingMessage.style.display = 'none';
      }
    }
    
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà
    summaryDateInput.addEventListener('change', fetchAndDisplayDailySummary);
    classSelect.addEventListener('change', fetchAndDisplayDailySummary);

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô)
    document.addEventListener('DOMContentLoaded', fetchAndDisplayDailySummary);
  </script>
</body>
</html>